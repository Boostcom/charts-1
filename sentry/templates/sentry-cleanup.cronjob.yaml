apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: {{ template "sentry.fullname" . }}-cleanup
  labels:
    app: sentry
    chart: "{{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}"
    release: "{{ .Release.Name }}"
    heritage: "{{ .Release.Service }}"
spec:
  schedule: "5 4 * * *"
  jobTemplate:
    spec:
      template:
        metadata:
          name: {{ template "sentry.fullname" . }}-cleanup
          annotations:
            checksum/configmap.yaml: {{ include (print $.Template.BasePath "/configmap-sentry.yaml") . | sha256sum }}
            {{- if .Values.sentry.worker.annotations }}
{{ toYaml .Values.sentry.worker.annotations | indent 12 }}
            {{- end }}
          labels:
            app: sentry
            release: "{{ .Release.Name }}"
            {{- if .Values.sentry.worker.podLabels }}
{{ toYaml .Values.sentry.worker.podLabels | indent 12 }}
            {{- end }}
        spec:
          restartPolicy: Never
          containers:
          - name: cleanup-job
            image: "{{ template "sentry.image" . }}"
            imagePullPolicy: {{ default "IfNotPresent" .Values.images.sentry.pullPolicy }}
            command: ["sentry","cleanup","--days", "14"]
            envFrom:
            - secretRef:
                name: sentry-secrets
            volumeMounts:
            - mountPath: /etc/sentry
              name: config
              readOnly: true
            resources:
{{ toYaml .Values.hooks.dbInit.resources | indent 14 }}
          volumes:
          - name: config
            configMap:
              name: {{ template "sentry.fullname" . }}-sentry
